{
  "feature": "dynamic-devcontainer",
  "version": "1.0",
  "created": "2026-01-25",
  "description": "Dynamic devcontainer configuration and automated container worker execution",
  "max_parallelization": 4,
  "total_tasks": 12,
  "critical_path": ["DC-002", "DC-003", "DC-004", "DC-009", "DC-012"],
  "levels": {
    "1": {
      "name": "Foundation",
      "description": "Independent foundational tasks with no dependencies",
      "tasks": ["DC-001", "DC-002", "DC-006"]
    },
    "2": {
      "name": "Core Generators",
      "description": "Build on foundation - dynamic generation and container launch",
      "tasks": ["DC-003", "DC-007"]
    },
    "3": {
      "name": "Integration",
      "description": "Wire components together",
      "tasks": ["DC-004", "DC-005", "DC-008"]
    },
    "4": {
      "name": "Orchestration",
      "description": "Full orchestrator integration",
      "tasks": ["DC-009", "DC-010"]
    },
    "5": {
      "name": "Polish",
      "description": "Documentation and testing",
      "tasks": ["DC-011", "DC-012"]
    }
  },
  "tasks": [
    {
      "id": "DC-001",
      "level": 1,
      "title": "Update init.py to use ProjectStack for multi-language detection",
      "description": "Replace single-type detect_project_type() with ProjectStack from security_rules.py. Display all detected languages, frameworks, and databases in init output.",
      "files_owned": ["zerg/commands/init.py"],
      "files_read": ["zerg/security_rules.py"],
      "dependencies": [],
      "estimate_minutes": 20,
      "critical_path": false,
      "verification": {
        "command": "cd /tmp && rm -rf test-dc && mkdir test-dc && cd test-dc && touch requirements.txt package.json go.mod && python -m zerg.commands.init 2>&1 | grep -E 'python|javascript|go'",
        "expected": "Shows multiple languages detected"
      },
      "acceptance_criteria": [
        "detect_project_type() returns ProjectStack instead of str",
        "init output shows all detected languages",
        "Backwards compatible with existing config structure"
      ]
    },
    {
      "id": "DC-002",
      "level": 1,
      "title": "Create devcontainer_features.py with feature mapping",
      "description": "Create new module with DEVCONTAINER_FEATURES dict mapping languages to ghcr.io feature URLs and CUSTOM_INSTALL_COMMANDS for unsupported languages.",
      "files_owned": ["zerg/devcontainer_features.py"],
      "files_read": [],
      "dependencies": [],
      "estimate_minutes": 15,
      "critical_path": true,
      "verification": {
        "command": "python -c \"from zerg.devcontainer_features import DEVCONTAINER_FEATURES, CUSTOM_INSTALL_COMMANDS; print(len(DEVCONTAINER_FEATURES), len(CUSTOM_INSTALL_COMMANDS))\"",
        "expected": "Prints counts without import error"
      },
      "acceptance_criteria": [
        "DEVCONTAINER_FEATURES maps 8+ languages to feature URLs",
        "CUSTOM_INSTALL_COMMANDS handles R, Julia, C++",
        "Includes version defaults for each feature"
      ]
    },
    {
      "id": "DC-006",
      "level": 1,
      "title": "Implement ContainerLauncher base class in launcher.py",
      "description": "Add ContainerLauncher class inheriting from WorkerLauncher. Implement spawn(), monitor(), terminate(), get_output() methods with Docker CLI commands.",
      "files_owned": ["zerg/launcher.py"],
      "files_read": [],
      "dependencies": [],
      "estimate_minutes": 45,
      "critical_path": false,
      "verification": {
        "command": "python -c \"from zerg.launcher import ContainerLauncher, LauncherType; print(ContainerLauncher.__bases__, LauncherType.CONTAINER.value)\"",
        "expected": "ContainerLauncher inherits WorkerLauncher"
      },
      "acceptance_criteria": [
        "ContainerLauncher implements all abstract methods",
        "Uses docker CLI for container operations",
        "Proper error handling for missing Docker",
        "Container naming follows zerg-worker-{id} pattern"
      ]
    },
    {
      "id": "DC-003",
      "level": 2,
      "title": "Create DynamicDevcontainerGenerator using features",
      "description": "Add DynamicDevcontainerGenerator class that takes ProjectStack and generates devcontainer.json with appropriate features from DEVCONTAINER_FEATURES mapping.",
      "files_owned": ["zerg/devcontainer_features.py"],
      "files_read": ["zerg/security_rules.py"],
      "dependencies": ["DC-002"],
      "estimate_minutes": 30,
      "critical_path": true,
      "verification": {
        "command": "python -c \"from zerg.devcontainer_features import DynamicDevcontainerGenerator; from zerg.security_rules import ProjectStack; g = DynamicDevcontainerGenerator(ProjectStack(languages={'python','go'})); print(g.generate_config())\"",
        "expected": "Returns dict with features for python and go"
      },
      "acceptance_criteria": [
        "Takes ProjectStack as input",
        "Generates features dict with correct URLs",
        "Handles custom install commands via postCreateCommand",
        "Uses base ubuntu image for multi-language"
      ]
    },
    {
      "id": "DC-007",
      "level": 2,
      "title": "Add container spawn with claude execution",
      "description": "Extend ContainerLauncher spawn() to mount worktree, set env vars, and execute claude --dangerously-skip-permissions inside container. Create worker_entry.sh script.",
      "files_owned": ["zerg/launcher.py", ".zerg/worker_entry.sh"],
      "files_read": [],
      "dependencies": ["DC-006"],
      "estimate_minutes": 40,
      "critical_path": false,
      "verification": {
        "command": "test -x .zerg/worker_entry.sh && grep -q 'claude' .zerg/worker_entry.sh && echo 'OK'",
        "expected": "OK"
      },
      "acceptance_criteria": [
        "worker_entry.sh is executable",
        "Script invokes claude with proper flags",
        "Container mounts worktree at /workspace",
        "ANTHROPIC_API_KEY passed to container"
      ]
    },
    {
      "id": "DC-004",
      "level": 3,
      "title": "Update create_devcontainer() to use dynamic generator",
      "description": "Modify create_devcontainer() in init.py to use DynamicDevcontainerGenerator with detected ProjectStack instead of static single-language config.",
      "files_owned": ["zerg/commands/init.py"],
      "files_read": ["zerg/devcontainer_features.py"],
      "dependencies": ["DC-001", "DC-003"],
      "estimate_minutes": 25,
      "critical_path": true,
      "verification": {
        "command": "cd /tmp && rm -rf test-dc2 && mkdir test-dc2 && cd test-dc2 && touch requirements.txt package.json && zerg init --no-security-rules && cat .devcontainer/devcontainer.json | python -c \"import sys,json; d=json.load(sys.stdin); print('python' in str(d.get('features',{})) and 'node' in str(d.get('features',{})))\"",
        "expected": "True"
      },
      "acceptance_criteria": [
        "Multi-language projects get multi-feature devcontainer",
        "Single-language projects still work",
        "postCreateCommand includes custom installs if needed"
      ]
    },
    {
      "id": "DC-005",
      "level": 3,
      "title": "Update .zerg/devcontainer.py for multi-language",
      "description": "Update DevcontainerGenerator in .zerg/devcontainer.py to support multi-language via features parameter. Maintain backwards compatibility.",
      "files_owned": [".zerg/devcontainer.py"],
      "files_read": ["zerg/devcontainer_features.py"],
      "dependencies": ["DC-003"],
      "estimate_minutes": 25,
      "critical_path": false,
      "verification": {
        "command": "python -c \"from importlib.util import spec_from_file_location, module_from_spec; spec = spec_from_file_location('dc', '.zerg/devcontainer.py'); m = module_from_spec(spec); spec.loader.exec_module(m); print(hasattr(m.DevcontainerGenerator, 'generate'))\"",
        "expected": "True"
      },
      "acceptance_criteria": [
        "DevcontainerGenerator accepts languages list",
        "Generates features-based config for multi-lang",
        "Falls back to single-image for single-lang"
      ]
    },
    {
      "id": "DC-008",
      "level": 3,
      "title": "Add auto-detect launcher mode in orchestrator",
      "description": "Update _create_launcher() in orchestrator.py to auto-detect: use ContainerLauncher if .devcontainer exists and image is built, otherwise SubprocessLauncher.",
      "files_owned": ["zerg/orchestrator.py"],
      "files_read": ["zerg/launcher.py"],
      "dependencies": ["DC-006"],
      "estimate_minutes": 20,
      "critical_path": false,
      "verification": {
        "command": "python -c \"from zerg.orchestrator import Orchestrator; from zerg.config import ZergConfig; c = ZergConfig(); print(hasattr(Orchestrator, '_create_launcher'))\"",
        "expected": "True"
      },
      "acceptance_criteria": [
        "Auto-detects based on devcontainer presence",
        "Checks if Docker image exists before using container mode",
        "Config override takes precedence over auto-detect"
      ]
    },
    {
      "id": "DC-009",
      "level": 4,
      "title": "Wire ContainerLauncher to orchestrator",
      "description": "Complete orchestrator integration: _spawn_worker uses ContainerLauncher when mode=container, _poll_workers monitors containers, _terminate_worker stops containers.",
      "files_owned": ["zerg/orchestrator.py"],
      "files_read": ["zerg/launcher.py"],
      "dependencies": ["DC-007", "DC-008"],
      "estimate_minutes": 35,
      "critical_path": true,
      "verification": {
        "command": "python -c \"from zerg.orchestrator import Orchestrator; from zerg.launcher import ContainerLauncher; print('ContainerLauncher' in str(Orchestrator._create_launcher.__code__.co_consts if hasattr(Orchestrator._create_launcher, '__code__') else 'ContainerLauncher'))\"",
        "expected": "True or shows ContainerLauncher reference"
      },
      "acceptance_criteria": [
        "Orchestrator uses ContainerLauncher for container mode",
        "Worker spawn creates containers with correct mounts",
        "Poll/terminate work for container workers"
      ]
    },
    {
      "id": "DC-010",
      "level": 4,
      "title": "Add --mode flag to rush command",
      "description": "Add --mode subprocess|container|auto option to zerg rush. Pass mode to orchestrator config. Default to 'auto'.",
      "files_owned": ["zerg/commands/rush.py"],
      "files_read": ["zerg/config.py"],
      "dependencies": ["DC-009"],
      "estimate_minutes": 15,
      "critical_path": false,
      "verification": {
        "command": "zerg rush --help | grep -E '\\-\\-mode'",
        "expected": "Shows --mode option in help"
      },
      "acceptance_criteria": [
        "--mode option accepts subprocess|container|auto",
        "Passed to config/orchestrator",
        "Default is 'auto'"
      ]
    },
    {
      "id": "DC-011",
      "level": 5,
      "title": "Update skill files with container mode docs",
      "description": "Update zerg:init.md and zerg:rush.md skill files to document multi-language detection and container mode options.",
      "files_owned": [".claude/commands/zerg:init.md", ".claude/commands/zerg:rush.md"],
      "files_read": [],
      "dependencies": ["DC-010"],
      "estimate_minutes": 20,
      "critical_path": false,
      "verification": {
        "command": "grep -l 'container' .claude/commands/zerg:*.md | wc -l",
        "expected": "2 or more files mention container"
      },
      "acceptance_criteria": [
        "zerg:init.md documents multi-language detection",
        "zerg:rush.md documents --mode flag",
        "Examples show container mode usage"
      ]
    },
    {
      "id": "DC-012",
      "level": 5,
      "title": "Integration test: full container flow",
      "description": "Create integration test that: inits multi-lang project, builds devcontainer, runs rush --mode container --dry-run, verifies correct launcher selection.",
      "files_owned": ["tests/integration/test_container_flow.py"],
      "files_read": [],
      "dependencies": ["DC-009", "DC-010", "DC-011"],
      "estimate_minutes": 30,
      "critical_path": true,
      "verification": {
        "command": "pytest tests/integration/test_container_flow.py -v --tb=short 2>&1 | tail -5",
        "expected": "Tests pass or skip if no Docker"
      },
      "acceptance_criteria": [
        "Test covers init → devcontainer → rush flow",
        "Skips gracefully if Docker unavailable",
        "Verifies multi-language detection"
      ]
    }
  ]
}
